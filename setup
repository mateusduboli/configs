#!/bin/bash
source setup.cfg

function makeDirs {
	for dir in ${MY_DIRS[@]} ; do
		mkdir -p $HOME/$dir 2>/dev/null
		if [ $? -eq 0 ]; then
			echo "Directory $HOME/$dir created."
		else
			echo "Directory $HOME/$dir already exists."
		fi
	done
}

function checkForDependencies {
	for program in ${PROGRAMS[@]}; do
		hash $program 2>/dev/null
		if [ $? -ne 0 ]; then
			echo "Install ${program} before running the script."
		fi
	done
}

function installOhMyZsh {
	WGET_ZSH="wget --no-check-certificate https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh -O -"
	CURL_ZSH="curl -L https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh"
	{ hash wget 2>/dev/null && $WGET_ZSH | sh; } || { hash curl 2>/dev/null && $CURL_ZSH | sh; }
}

function linkFiles {
	for file in $DOT_FILES/* ; do
		filename=$(basename $file)
		dest="$HOME/.$filename"
		mv $dest "$BACKUP/$filename" 2>/dev/null
		if [ $? -eq 0 ]; then
			echo "Saving : $dest"
		fi
		ln -s $DOT_FILES/$filename $dest
		echo "Linking : $dest"
	done
}

function installVundle {
	# Install Vundle
	CONQUE_BALL=conque_2.3.vmb
	mkdir tmp
	git clone https://github.com/gmarik/vundle ~/.vim/bundle/vundle 2>/dev/null
	cd tmp && wget https://conque.googlecode.com/files/$CONQUE_BALL
	vim +BundleInscurl -L https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh | shtall +"source tmp/$CONQUE_BALL" +qall
	cd .. && rm -rf tmp
}

function usage {
	printf "Configuration management"
	printf "\nExample usage"
	printf "\nsetup [-h]"
	printf "\n\tThis menu."
	printf "\n-c"
	printf "\n\tCheckout\\Clone the repositories into the ~/Repositories folder"
	printf "\n-d"
	printf "\n\tCreate default directories in the user's home folder"
	printf "\n-i"
	printf "\n\tLink and Copy the link and copy folders into the user's home directory"
	printf "\n-u"
	printf "\n\tUpdate\\Pull the repositories on the ~/Repositories folder"
	printf "\n-g"
	printf "\n\tDiffs and copies the new files from the link and copy folders, into the user's home directory"
	printf "\n-r"
	printf "\n\tRemove the links installed in the user's home directory, and replaces then with the backups"
	printf "\n"
}

# If no arguments passed, then print usage and exit
if [ "$#" == 0 ]; then
	usage
	exit 1
fi

while getopts ":hicdugr" OPTION; do
	case $OPTION in
		h)
			usage
			exit 1
			;;
		i)
			mkdir $BACKUP 2>/dev/null
			linkFiles
			installOhMyZsh
			installVundle
			;;
		d)
			checkForDependencies
			;;
		c)
			echo "NOT IMPLEMENTED"
			echo "Checkout Repos"
			;;
		u)
			echo "NOT IMPLEMENTED"
			echo "Update repos"
			;;
		g)
			echo "NOT IMPLEMENTED"
			echo "Upgrade"
			;;
		r)
			echo "NOT IMPLEMENTED"
			echo "Uninstall"
			;;
		?)
			usage
			exit 1
			;;
	esac
done
